HOVERNET:

What was done:

define a new dataset class for Lizard in dataset.py.

setup the environement:
```
conda env create -f environment.yml
conda activate hovernet
pip install torch==1.6.0 torchvision==0.7.0
```

Run training:
```
python models/hover_net/run_train.py --gpu='0'
```

# Lizard:

data utils-> data_extraction.py

extract the splited data source into a pkl file with annotations.

## Extract data :
```
python sflizard/data_utils/data_extraction.py -ip data/Lizard_dataset/Lizard_Images1 data/Lizard_dataset/Lizard_Images2 -mf data/Lizard_dataset/Lizard_Labels/Labels -of data_540_200_v2.pkl
```



## Stardist:

Update model to use pytorch lightning.

training stardist:
```
python sflizard/training.py --data_path=data-540-200.pkl --max_epochs=10 --batch_size=4 --gpus=1
```

After 10 epochs, 0.729 accuracy

### training stardist with classes:

After stuck at 80% accuracy on graph, try to train stardist to output classes.

Adapt model to accept classes like in the original tensorflow model (modified UnetStar and create new loss in models_utils)

training stardist with classification:

```
python sflizard/training.py --model=stardist_class --data_path=data_540_200_v3.pkl --max_epochs=10 --batch_size=4 --num_workers=1 --gpus=1
```

Improved the testing phase to get more information on quality of training. Add an accuracy and f1 metric for classification.

After 10 epochs

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃        Test metric        ┃       DataLoader 0        ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│         test acc          │    0.6956533193588257     │
│          test f1          │    0.8196528553962708     │
│   test panoptic_quality   │    0.6261826157569885     │
│      test precision       │    0.8074914216995239     │
│        test recall        │    0.8326866030693054     │
└───────────────────────────┴───────────────────────────┘

┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃        macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.8429019451141357 │ 0.1428571492433548  │
│      F1      │ 0.8429019451141357 │ 0.13067929446697235 │
└──────────────┴────────────────────┴─────────────────────┘

After 63 epochs

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃        Test metric        ┃       DataLoader 0        ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│         test acc          │    0.8036224246025085     │
│          test f1          │     0.890741765499115     │
│   test panoptic_quality   │    0.7090872526168823     │
│      test precision       │    0.8933470845222473     │
│        test recall        │    0.8883785009384155     │
└───────────────────────────┴───────────────────────────┘

┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro       ┃        macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.946998655796051 │ 0.4916241765022278  │
│      F1      │ 0.946998655796051 │ 0.47460973262786865 │
└──────────────┴───────────────────┴─────────────────────┘


## Graph:

Graph datamodule with pytorch geometric
https://pytorch-geometric.readthedocs.io/en/latest/notes/introduction.html#data-handling-of-graphs
https://pytorch-geometric.readthedocs.io/en/latest/notes/create_dataset.html

Training graphs and exploring models.

model results :

### 1:

```
    def __init__(self, dim_in, dim_h, dim_out, layer_type):
        super().__init__()
        self.model = torch.nn.ModuleList()
        self.model.append(Linear(dim_in, 1024))
        self.model.append(Linear(1024, 1024))
        self.model.append(Linear(1024, dim_h))
        for i in range(3):
            self.model.append(layer_type(dim_h, dim_h))
            self.model.append(layer_type(dim_h, dim_h))
            self.model.append(layer_type(dim_h, dim_h))
            self.model.append(layer_type(dim_h, dim_h))
            self.model.append(JumpingKnowledge("cat", dim_h))
            self.model.append(Linear(4 * dim_h, dim_h))
        self.model.append(Linear(dim_h, dim_out))

    def forward(self, x, edge_index, edge_attr):
        x = self.model[0](x).relu()
        x = self.model[1](x).relu()
        x = self.model[2](x).relu()
        for i in range(3):
            xa = self.model[6 * i + 3](x, edge_index).relu()
            xb = self.model[6 * i + 4](xa, edge_index).relu()
            xc = self.model[6 * i + 5](xb, edge_index).relu()
            xd = self.model[6 * i + 6](xc, edge_index).relu()
            x = self.model[6 * i + 7]([xa, xb, xc, xd])
            x = self.model[6 * i + 8](x).relu()
        x = self.model[-1](x)
        return x
```
batch size 2
lr 0.0001
dimh 512

after 1267 epochs: 
acc 0.79772
loss 0.6011

# Improvements

## class balancing

counting the number of each occurence in the training set.

Used the dataset_weights.ipynb notebook.

Found these results for data_540_200.pkl:

```
{0: 0.822068738042566, 1: 0.0015632805252265753, 2: 0.13668895606007572, 3: 0.01808995955003234, 4: 0.006081943184276731, 5: 0.0005239083549402539, 6: 0.014983214282882448}
```

Found these results for data_540_200_v3.pkl

```
{0: 0.8435234983048621, 1: 0.0015844697497448515, 2: 0.09702835179125052, 3: 0.018770678077839286, 4: 0.005716505874930195, 5: 0.0011799091886332306, 6: 0.03219658701273987}
```


## stardist loss scaling

initial result after 1 epoch:
                  Classification metrics                   
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃        macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.8429019451141357 │ 0.1428571492433548  │
│      F1      │ 0.8429019451141357 │ 0.13067929446697235 │
└──────────────┴────────────────────┴─────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃        Test metric        ┃       DataLoader 0        ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│         test acc          │    0.20039373636245728    │
│          test f1          │    0.33140602707862854    │
│   test panoptic_quality   │    0.2023274451494217     │
│      test precision       │    0.28300514817237854    │
│        test recall        │    0.40644845366477966    │
└───────────────────────────┴───────────────────────────┘


The loss where scaled to all be 1 based on the mean of their values after the first epoch of training.

The result was the folloing after 1 epoch:

                  Classification metrics                   
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃        macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.8429019451141357 │ 0.1428571492433548  │
│      F1      │ 0.8429019451141357 │ 0.13067929446697235 │
└──────────────┴────────────────────┴─────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃        Test metric        ┃       DataLoader 0        ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│         test acc          │    0.1862340271472931     │
│          test f1          │    0.31149712204933167    │
│   test panoptic_quality   │    0.1853438764810562     │
│      test precision       │    0.2820425033569336     │
│        test recall        │    0.3515917658805847     │
└───────────────────────────┴───────────────────────────┘

The results are less good than previously.

They were then scaled to 1 for class, 2 for dists and 3 for probs. The result where the following after 1 epoch:

                  Classification metrics                  
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro       ┃        macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.842901885509491 │ 0.1428571343421936  │
│      F1      │ 0.842901885509491 │ 0.13067929446697235 │
└──────────────┴───────────────────┴─────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃        Test metric        ┃       DataLoader 0        ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│         test acc          │    0.20427483320236206    │
│          test f1          │    0.3362544775009155     │
│   test panoptic_quality   │    0.2056775987148285     │
│      test precision       │    0.30586540699005127    │
│        test recall        │    0.37778493762016296    │
└───────────────────────────┴───────────────────────────┘

We can see a slightly improvement, except for recall.

The next test was increasing the scaling dif. 1 for class, 4 for dists and 9 for probs. 

                  Classification metrics                   
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃        macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.8429016470909119 │ 0.14285710453987122 │
│      F1      │ 0.8429016470909119 │ 0.13067927956581116 │
└──────────────┴────────────────────┴─────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃        Test metric        ┃       DataLoader 0        ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│         test acc          │    0.2372918426990509     │
│          test f1          │    0.38001713156700134    │
│   test panoptic_quality   │    0.24237261712551117    │
│      test precision       │    0.3318764269351959     │
│        test recall        │    0.4514925479888916     │
└───────────────────────────┴───────────────────────────┘

We can see the results are now way better.

Trained on 10 epochs:

                  Classification metrics                   
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃        macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.8429019451141357 │ 0.1428571492433548  │
│      F1      │ 0.8429019451141357 │ 0.13067929446697235 │
└──────────────┴────────────────────┴─────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃        Test metric        ┃       DataLoader 0        ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│         test acc          │    0.6740047931671143     │
│          test f1          │    0.8042128682136536     │
│   test panoptic_quality   │    0.6061199307441711     │
│      test precision       │     0.808899462223053     │
│        test recall        │    0.8002299070358276     │
└───────────────────────────┴───────────────────────────┘

It is less better than before

Trained on 10 epochs for 1,2,3:

                  Classification metrics                   
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃        macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.8429019451141357 │ 0.1428571492433548  │
│      F1      │ 0.8429019451141357 │ 0.13067929446697235 │
└──────────────┴────────────────────┴─────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃        Test metric        ┃       DataLoader 0        ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│         test acc          │    0.6773419976234436     │
│          test f1          │    0.8066139817237854     │
│   test panoptic_quality   │    0.5979352593421936     │
│      test precision       │    0.7908514142036438     │
│        test recall        │    0.8235799670219421     │
└───────────────────────────┴───────────────────────────┘

Results don't seem to be better here also...

Trained on 50 epochs for 1,2,3:

┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃        macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.8429019451141357 │ 0.1428571492433548  │
│      F1      │ 0.8429019451141357 │ 0.13067929446697235 │
└──────────────┴────────────────────┴─────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃        Test metric        ┃       DataLoader 0        ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│         test acc          │    0.7525336146354675     │
│          test f1          │    0.8581790328025818     │
│   test panoptic_quality   │     0.655806303024292     │
│      test precision       │    0.8672865033149719     │
│        test recall        │    0.8501970171928406     │
└───────────────────────────┴───────────────────────────┘

Trained on 50 epochs for 1,1,1:

┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃        macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.8429019451141357 │ 0.1428571492433548  │
│      F1      │ 0.8429019451141357 │ 0.13067929446697235 │
└──────────────┴────────────────────┴─────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃        Test metric        ┃       DataLoader 0        ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│         test acc          │     0.776284396648407     │
│          test f1          │    0.8736357688903809     │
│   test panoptic_quality   │    0.6889598369598389     │
│      test precision       │    0.9006021618843079     │
│        test recall        │    0.8489930033683777     │
└───────────────────────────┴───────────────────────────┘

Trained on 50 epochs for 1,4,9:

┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃        macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.8429019451141357 │ 0.1428571492433548  │
│      F1      │ 0.8429019451141357 │ 0.13067929446697235 │
└──────────────┴────────────────────┴─────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃        Test metric        ┃       DataLoader 0        ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│         test acc          │    0.7730988264083862     │
│          test f1          │    0.8715329766273499     │
│   test panoptic_quality   │    0.6859904527664185     │
│      test precision       │    0.9018048048019409     │
│        test recall        │    0.8438259959220886     │
└───────────────────────────┴───────────────────────────┘

Pipeline script with metrics

For the test phase of full_training_stardist_class_140_20221111065433

                  Classification metrics                   
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃        macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.8429019451141357 │ 0.1428571492433548  │
│      F1      │ 0.8429019451141357 │ 0.13067929446697235 │
└──────────────┴────────────────────┴─────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃        Test metric        ┃       DataLoader 0        ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│         test acc          │     0.84881591796875      │
│          test f1          │    0.9178445339202881     │
│   test panoptic_quality   │    0.7338874936103821     │
│      test precision       │    0.9075508713722229     │
│        test recall        │    0.9284806847572327     │
└───────────────────────────┴───────────────────────────┘



Improvement :

Add IOU to classification metrics


---------------

test with full_training_graph_sage_200_1024_4_08559 + full_training_stardist_class_1000_2022_11_19_16_33_22
Results:

    Segmentation metrics     
┏━━━━━━━━━━━━━━━━━━┳━━━━━━━━┓
┃      Metric      ┃ Value  ┃
┡━━━━━━━━━━━━━━━━━━╇━━━━━━━━┩
│    precision     │ 0.9041 │
│      recall      │ 0.9282 │
│       acc        │ 0.8450 │
│        f1        │ 0.9160 │
│ panoptic_quality │ 0.7307 │
└──────────────────┴────────┘
                  Classification metrics                  
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃       macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.9451601505279541 │ 0.7351210117340088 │
│      F1      │ 0.9451601505279541 │ 0.6983742117881775 │
└──────────────┴────────────────────┴────────────────────┘
                                          Per class metrics                                          
┏━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃      Class       ┃ Neutrophil ┃ Epithelial ┃ Lymphocyte ┃ Plasma ┃ Eosinophil ┃ Connective tissue ┃
┡━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│    precision     │   0.0404   │   0.9087   │   0.4598   │ 0.1345 │   0.6066   │      0.5127       │
│      recall      │   0.0775   │   0.9455   │   0.4635   │ 0.1393 │   0.5495   │      0.5100       │
│       acc        │   0.0273   │   0.8635   │   0.3001   │ 0.0735 │   0.4051   │      0.3435       │
│        f1        │   0.0531   │   0.9268   │   0.4616   │ 0.1369 │   0.5766   │      0.5113       │
│ panoptic_quality │   0.0307   │   0.6535   │   0.2734   │ 0.0822 │   0.3799   │      0.3085       │
└──────────────────┴────────────┴────────────┴────────────┴────────┴────────────┴───────────────────┘
                                          Per class metrics                                          
┏━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃      Class       ┃ Neutrophil ┃ Epithelial ┃ Lymphocyte ┃ Plasma ┃ Eosinophil ┃ Connective tissue ┃
┡━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│    precision     │   0.2421   │   0.9608   │   0.4872   │ 0.1497 │   0.5539   │      0.6910       │
│      recall      │   0.3289   │   0.9581   │   0.4878   │ 0.1455 │   0.5470   │      0.6937       │
│       acc        │   0.1621   │   0.9220   │   0.3223   │ 0.0797 │   0.3797   │      0.5295       │
│        f1        │   0.2789   │   0.9594   │   0.4875   │ 0.1476 │   0.5504   │      0.6924       │
│ panoptic_quality │   0.1824   │   0.6819   │   0.2936   │ 0.0837 │   0.3655   │      0.4306       │
└──────────────────┴────────────┴────────────┴────────────┴────────┴────────────┴───────────────────┘
Plotting...
Done.

---------------------------------

New stardist training with 2000 epochs 1-4-9

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃        Test metric        ┃       DataLoader 0        ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│         test acc          │    0.8710618615150452     │
│          test f1          │    0.9306829571723938     │
│   test panoptic_quality   │    0.7605668306350708     │
│      test precision       │    0.9198489785194397     │
│        test recall        │    0.9418487548828125     │
└───────────────────────────┴───────────────────────────┘


Wandb stardist 200 epochs 1-2-3 1e-4

                  Classification metrics                  
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃       macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.8473870158195496 │ 0.7577422261238098 │
│      F1      │ 0.8473869562149048 │ 0.4956516623497009 │
└──────────────┴────────────────────┴────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃        Test metric        ┃       DataLoader 0        ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│         test acc          │    0.8655156493186951     │
│          test f1          │    0.9275092482566833     │
│   test panoptic_quality   │    0.7495335936546326     │
│      test precision       │    0.9172927737236023     │
│        test recall        │    0.9380306601524353     │
└───────────────────────────┴───────────────────────────┘

Wandb stardist 200 epochs 1-4-9 1e-4

                  Classification metrics                  
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃       macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.8329102396965027 │  0.71375972032547  │
│      F1      │ 0.8329102396965027 │ 0.4258592128753662 │
└──────────────┴────────────────────┴────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃        Test metric        ┃       DataLoader 0        ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│         test acc          │    0.8591146469116211     │
│          test f1          │     0.923774242401123     │
│   test panoptic_quality   │    0.7386745810508728     │
│      test precision       │    0.9105618000030518     │
│        test recall        │    0.9374590516090393     │
└───────────────────────────┴───────────────────────────┘


Wandb stardist 200 epochs 1-1-1 1e-4

┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃       macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.9177733659744263 │ 0.8934208154678345 │
│      F1      │ 0.9177733659744263 │ 0.7253755331039429 │
└──────────────┴────────────────────┴────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃        Test metric        ┃       DataLoader 0        ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│         test acc          │    0.8617271780967712     │
│          test f1          │    0.9253953099250793     │
│   test panoptic_quality   │    0.7482020258903503     │
│      test precision       │    0.9141808748245239     │
│        test recall        │    0.9369679689407349     │
└───────────────────────────┴───────────────────────────┘

Trying to apply transformation to stardist :

augmentation 1 : flip
augmentation 2 : flip + rotate

#### Wandb stardist 1000 epochs 1-2-3 1e-4

                  Classification metrics                  
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃       macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.9294363856315613 │ 0.8997076153755188 │
│      F1      │ 0.929436445236206  │ 0.7468479871749878 │
└──────────────┴────────────────────┴────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃        Test metric        ┃       DataLoader 0        ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│         test acc          │    0.8943765163421631     │
│          test f1          │    0.9439024329185486     │
│   test panoptic_quality   │    0.7775465250015259     │
│      test precision       │    0.9365381002426147     │
│        test recall        │     0.951421856880188     │
└───────────────────────────┴───────────────────────────┘

    Segmentation metrics     
┏━━━━━━━━━━━━━━━━━━┳━━━━━━━━┓
┃      Metric      ┃ Value  ┃
┡━━━━━━━━━━━━━━━━━━╇━━━━━━━━┩
│    precision     │ 0.7885 │
│      recall      │ 0.8266 │
│       acc        │ 0.6765 │
│        f1        │ 0.8071 │
│ panoptic_quality │ 0.6334 │
└──────────────────┴────────┘
                 Classification metrics                  
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro       ┃       macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.903045654296875 │ 0.5758374333381653 │
│      F1      │ 0.903045654296875 │ 0.6099082231521606 │
└──────────────┴───────────────────┴────────────────────┘
                              Per class metrics                               
┏━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┓
┃          ┃          ┃          ┃           ┃        ┃          ┃ Connecti… ┃
┃  Class   ┃ Neutrop… ┃ Epithel… ┃ Lymphocy… ┃ Plasma ┃ Eosinop… ┃  tissue   ┃
┡━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━┩
│ precisi… │  0.0138  │  0.8893  │  0.5082   │ 0.0412 │  0.0705  │  0.3279   │
│  recall  │  0.0234  │  0.8893  │  0.5082   │ 0.0426 │  0.0753  │  0.3292   │
│   acc    │  0.0088  │  0.8007  │  0.3407   │ 0.0214 │  0.0378  │  0.1966   │
│    f1    │  0.0174  │  0.8893  │  0.5082   │ 0.0418 │  0.0728  │  0.3285   │
│ panopti… │  0.0099  │  0.5270  │  0.2850   │ 0.0222 │  0.0476  │  0.1785   │
└──────────┴──────────┴──────────┴───────────┴────────┴──────────┴───────────┘

#### Wandb stardist 1000 epochs 1-2-3 1e-4 augmentations 1

                  Classification metrics                  
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃       macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.8845038414001465 │  0.77449631690979  │
│      F1      │ 0.8845038414001465 │ 0.6294546127319336 │
└──────────────┴────────────────────┴────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃        Test metric        ┃       DataLoader 0        ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│         test acc          │    0.7371266484260559     │
│          test f1          │     0.843948245048523     │
│   test panoptic_quality   │    0.6694356203079224     │
│      test precision       │    0.8262781500816345     │
│        test recall        │     0.863277792930603     │
└───────────────────────────┴───────────────────────────┘

with test script

    Segmentation metrics     
┏━━━━━━━━━━━━━━━━━━┳━━━━━━━━┓
┃      Metric      ┃ Value  ┃
┡━━━━━━━━━━━━━━━━━━╇━━━━━━━━┩
│    precision     │ 0.8321 │
│      recall      │ 0.8691 │
│       acc        │ 0.7394 │
│        f1        │ 0.8502 │
│ panoptic_quality │ 0.6762 │
└──────────────────┴────────┘
                  Classification metrics                  
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃       macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.9148610830307007 │ 0.6568082571029663 │
│      F1      │ 0.9148610830307007 │ 0.671626627445221  │
└──────────────┴────────────────────┴────────────────────┘
                              Per class metrics                               
┏━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┓
┃          ┃          ┃          ┃           ┃        ┃          ┃ Connecti… ┃
┃  Class   ┃ Neutrop… ┃ Epithel… ┃ Lymphocy… ┃ Plasma ┃ Eosinop… ┃  tissue   ┃
┡━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━┩
│ precisi… │  0.0092  │  0.9508  │  0.6352   │ 0.1516 │  0.1974  │  0.5123   │
│  recall  │  0.0156  │  0.9508  │  0.6352   │ 0.1574 │  0.2055  │  0.5144   │
│   acc    │  0.0058  │  0.9062  │  0.4655   │ 0.0837 │  0.1119  │  0.3453   │
│    f1    │  0.0116  │  0.9508  │  0.6352   │ 0.1545 │  0.2013  │  0.5133   │
│ panopti… │  0.0104  │  0.6031  │  0.3702   │ 0.0887 │  0.1224  │  0.2893   │
└──────────┴──────────┴──────────┴───────────┴────────┴──────────┴───────────┘

#### Wandb stardist 1000 epochs 1-2-3 1e-4 augmentations 1

    Segmentation metrics     
┏━━━━━━━━━━━━━━━━━━┳━━━━━━━━┓
┃      Metric      ┃ Value  ┃
┡━━━━━━━━━━━━━━━━━━╇━━━━━━━━┩
│    precision     │ 0.8423 │
│      recall      │ 0.8818 │
│       acc        │ 0.7569 │
│        f1        │ 0.8616 │
│ panoptic_quality │ 0.6886 │
└──────────────────┴────────┘
                  Classification metrics                  
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃       macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.9168312549591064 │ 0.6756399869918823 │
│      F1      │ 0.9168312549591064 │ 0.6730197668075562 │
└──────────────┴────────────────────┴────────────────────┘
                              Per class metrics                               
┏━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┓
┃          ┃          ┃          ┃           ┃        ┃          ┃ Connecti… ┃
┃  Class   ┃ Neutrop… ┃ Epithel… ┃ Lymphocy… ┃ Plasma ┃ Eosinop… ┃  tissue   ┃
┡━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━┩
│ precisi… │  0.0138  │  0.9549  │  0.6270   │ 0.1230 │  0.1311  │  0.6107   │
│  recall  │  0.0234  │  0.9549  │  0.6270   │ 0.1277 │  0.1644  │  0.6132   │
│   acc    │  0.0087  │  0.9137  │  0.4567   │ 0.0668 │  0.0787  │  0.4408   │
│    f1    │  0.0173  │  0.9549  │  0.6270   │ 0.1253 │  0.1459  │  0.6119   │
│ panopti… │  0.0114  │  0.6117  │  0.3705   │ 0.0705 │  0.0942  │  0.3487   │
└──────────┴──────────┴──────────┴───────────┴────────┴──────────┴───────────┘

#### Wandb stardist 1000 epochs 1-2-3 1e-4 augmentations 1

    Segmentation metrics     
┏━━━━━━━━━━━━━━━━━━┳━━━━━━━━┓
┃      Metric      ┃ Value  ┃
┡━━━━━━━━━━━━━━━━━━╇━━━━━━━━┩
│    precision     │ 0.8462 │
│      recall      │ 0.8793 │
│       acc        │ 0.7581 │
│        f1        │ 0.8624 │
│ panoptic_quality │ 0.6913 │
└──────────────────┴────────┘
                  Classification metrics                  
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃       macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.9176459908485413 │ 0.6743224859237671 │
│      F1      │ 0.9176459908485413 │ 0.6776493787765503 │
└──────────────┴────────────────────┴────────────────────┘
                              Per class metrics                               
┏━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┓
┃          ┃          ┃          ┃           ┃        ┃          ┃ Connecti… ┃
┃  Class   ┃ Neutrop… ┃ Epithel… ┃ Lymphocy… ┃ Plasma ┃ Eosinop… ┃  tissue   ┃
┡━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━┩
│ precisi… │  0.0140  │  0.9590  │  0.6189   │ 0.1352 │  0.1173  │  0.6189   │
│  recall  │  0.0234  │  0.9590  │  0.6189   │ 0.1404 │  0.1438  │  0.6214   │
│   acc    │  0.0088  │  0.9213  │  0.4481   │ 0.0740 │  0.0691  │  0.4494   │
│    f1    │  0.0175  │  0.9590  │  0.6189   │ 0.1378 │  0.1292  │  0.6201   │
│ panopti… │  0.0111  │  0.6159  │  0.3687   │ 0.0773 │  0.0832  │  0.3559   │
└──────────┴──────────┴──────────┴───────────┴────────┴──────────┴───────────┘


#### Wandb stardist 1000 epochs 1-1-1 1e-4 

                  Classification metrics                  
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃       macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.9322977066040039 │ 0.9160791039466858 │
│      F1      │ 0.9322977066040039 │ 0.7695453763008118 │
└──────────────┴────────────────────┴────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃        Test metric        ┃       DataLoader 0        ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│         test acc          │    0.8935486078262329     │
│          test f1          │    0.9434435367584229     │
│   test panoptic_quality   │    0.7785550951957703     │
│      test precision       │    0.9350399971008301     │
│        test recall        │    0.9520648121833801     │
└───────────────────────────┴───────────────────────────┘

Test with test script
    Segmentation metrics     
┏━━━━━━━━━━━━━━━━━━┳━━━━━━━━┓
┃      Metric      ┃ Value  ┃
┡━━━━━━━━━━━━━━━━━━╇━━━━━━━━┩
│    precision     │ 0.7792 │
│      recall      │ 0.8213 │
│       acc        │ 0.6662 │
│        f1        │ 0.7997 │
│ panoptic_quality │ 0.6267 │
└──────────────────┴────────┘
                  Classification metrics                  
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃       macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.9013381600379944 │ 0.5707722902297974 │
│      F1      │ 0.9013381600379944 │ 0.5948783755302429 │
└──────────────┴────────────────────┴────────────────────┘
                              Per class metrics                               
┏━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┓
┃          ┃          ┃          ┃           ┃        ┃          ┃ Connecti… ┃
┃  Class   ┃ Neutrop… ┃ Epithel… ┃ Lymphocy… ┃ Plasma ┃ Eosinop… ┃  tissue   ┃
┡━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━┩
│ precisi… │  0.0000  │  0.9098  │  0.4590   │ 0.0164 │  0.0645  │  0.2336   │
│  recall  │  0.0000  │  0.9098  │  0.4590   │ 0.0170 │  0.0685  │  0.2346   │
│   acc    │  0.0000  │  0.8346  │  0.2979   │ 0.0084 │  0.0344  │  0.1326   │
│    f1    │  0.0000  │  0.9098  │  0.4590   │ 0.0167 │  0.0664  │  0.2341   │
│ panopti… │  0.0000  │  0.5335  │  0.2574   │ 0.0087 │  0.0475  │  0.1262   │
└──────────┴──────────┴──────────┴───────────┴────────┴──────────┴───────────┘


#### Wandb stardist 1000 epochs 1-1-1 1e-4 augmentation 1

                  Classification metrics                  
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃       macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.8804959058761597 │ 0.7796707153320312 │
│      F1      │ 0.8804959058761597 │ 0.6275386214256287 │
└──────────────┴────────────────────┴────────────────────┘
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃        Test metric        ┃       DataLoader 0        ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│         test acc          │     0.749176025390625     │
│          test f1          │    0.8521330952644348     │
│   test panoptic_quality   │    0.6769529581069946     │
│      test precision       │    0.8366040587425232     │
│        test recall        │    0.8687527775764465     │
└───────────────────────────┴───────────────────────────┘

Test with script

    Segmentation metrics     
┏━━━━━━━━━━━━━━━━━━┳━━━━━━━━┓
┃      Metric      ┃ Value  ┃
┡━━━━━━━━━━━━━━━━━━╇━━━━━━━━┩
│    precision     │ 0.8431 │
│      recall      │ 0.8750 │
│       acc        │ 0.7525 │
│        f1        │ 0.8587 │
│ panoptic_quality │ 0.6840 │
└──────────────────┴────────┘
                  Classification metrics                  
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃       macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.9166155457496643 │ 0.6568154096603394 │
│      F1      │ 0.9166155457496643 │ 0.6800734996795654 │
└──────────────┴────────────────────┴────────────────────┘
                              Per class metrics                               
┏━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┓
┃          ┃          ┃          ┃           ┃        ┃          ┃ Connecti… ┃
┃  Class   ┃ Neutrop… ┃ Epithel… ┃ Lymphocy… ┃ Plasma ┃ Eosinop… ┃  tissue   ┃
┡━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━┩
│ precisi… │  0.0255  │  0.9426  │  0.6844   │ 0.1333 │  0.1503  │  0.6189   │
│  recall  │  0.0391  │  0.9426  │  0.6844   │ 0.1362 │  0.1781  │  0.6214   │
│   acc    │  0.0157  │  0.8915  │  0.5202   │ 0.0722 │  0.0887  │  0.4494   │
│    f1    │  0.0309  │  0.9426  │  0.6844   │ 0.1347 │  0.1630  │  0.6201   │
│ panopti… │  0.0220  │  0.6037  │  0.4014   │ 0.0757 │  0.1018  │  0.3588   │
└──────────┴──────────┴──────────┴───────────┴────────┴──────────┴───────────┘

#### Wandb stardist 1000 epochs 1-1-1 1e-4 augmentation 2

    Segmentation metrics     
┏━━━━━━━━━━━━━━━━━━┳━━━━━━━━┓
┃      Metric      ┃ Value  ┃
┡━━━━━━━━━━━━━━━━━━╇━━━━━━━━┩
│    precision     │ 0.8555 │
│      recall      │ 0.8790 │
│       acc        │ 0.7654 │
│        f1        │ 0.8671 │
│ panoptic_quality │ 0.6923 │
└──────────────────┴────────┘
                  Classification metrics                  
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃       macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.9180213212966919 │ 0.6825199723243713 │
│      F1      │ 0.9180213212966919 │ 0.6894713640213013 │
└──────────────┴────────────────────┴────────────────────┘
                              Per class metrics                               
┏━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┓
┃          ┃          ┃          ┃           ┃        ┃          ┃ Connecti… ┃
┃  Class   ┃ Neutrop… ┃ Epithel… ┃ Lymphocy… ┃ Plasma ┃ Eosinop… ┃  tissue   ┃
┡━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━┩
│ precisi… │  0.0151  │  0.9508  │  0.6680   │ 0.1557 │  0.1786  │  0.6214   │
│  recall  │  0.0234  │  0.9508  │  0.6680   │ 0.1617 │  0.2055  │  0.6214   │
│   acc    │  0.0093  │  0.9062  │  0.5015   │ 0.0862 │  0.1056  │  0.4507   │
│    f1    │  0.0183  │  0.9508  │  0.6680   │ 0.1587 │  0.1911  │  0.6214   │
│ panopti… │  0.0102  │  0.6138  │  0.3934   │ 0.0869 │  0.1137  │  0.3590   │
└──────────┴──────────┴──────────┴───────────┴────────┴──────────┴───────────┘


### exploring LR

#### wandb stardist 1000 epochs 1-1-1 1e-5 augm2

    Segmentation metrics     
┏━━━━━━━━━━━━━━━━━━┳━━━━━━━━┓
┃      Metric      ┃ Value  ┃
┡━━━━━━━━━━━━━━━━━━╇━━━━━━━━┩
│    precision     │ 0.8314 │
│      recall      │ 0.8678 │
│       acc        │ 0.7380 │
│        f1        │ 0.8492 │
│ panoptic_quality │ 0.6649 │
└──────────────────┴────────┘
                  Classification metrics                  
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃       macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.9120211005210876 │ 0.6430404186248779 │
│      F1      │ 0.9120210409164429 │ 0.6524866819381714 │
└──────────────┴────────────────────┴────────────────────┘
                              Per class metrics                               
┏━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┓
┃          ┃          ┃          ┃           ┃        ┃          ┃ Connecti… ┃
┃  Class   ┃ Neutrop… ┃ Epithel… ┃ Lymphocy… ┃ Plasma ┃ Eosinop… ┃  tissue   ┃
┡━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━┩
│ precisi… │  0.0045  │  0.9508  │  0.5123   │ 0.0697 │  0.0823  │  0.3934   │
│  recall  │  0.0078  │  0.9508  │  0.5123   │ 0.0723 │  0.0890  │  0.3951   │
│   acc    │  0.0029  │  0.9062  │  0.3444   │ 0.0368 │  0.0447  │  0.2455   │
│    f1    │  0.0057  │  0.9508  │  0.5123   │ 0.0710 │  0.0855  │  0.3943   │
│ panopti… │  0.0036  │  0.5933  │  0.2952   │ 0.0378 │  0.0577  │  0.2186   │
└──────────┴──────────┴──────────┴───────────┴────────┴──────────┴───────────┘

#### wandb stardist 1000 epochs 1-1-1 1e-3 augm2

    Segmentation metrics     
┏━━━━━━━━━━━━━━━━━━┳━━━━━━━━┓
┃      Metric      ┃ Value  ┃
┡━━━━━━━━━━━━━━━━━━╇━━━━━━━━┩
│    precision     │ 0.8309 │
│      recall      │ 0.8710 │
│       acc        │ 0.7398 │
│        f1        │ 0.8505 │
│ panoptic_quality │ 0.6686 │
└──────────────────┴────────┘
                  Classification metrics                  
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃       macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.9152989387512207 │ 0.6819437742233276 │
│      F1      │ 0.9152989387512207 │ 0.6682782173156738 │
└──────────────┴────────────────────┴────────────────────┘
                              Per class metrics                               
┏━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┓
┃          ┃          ┃          ┃           ┃        ┃          ┃ Connecti… ┃
┃  Class   ┃ Neutrop… ┃ Epithel… ┃ Lymphocy… ┃ Plasma ┃ Eosinop… ┃  tissue   ┃
┡━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━┩
│ precisi… │  0.0044  │  0.9713  │  0.5697   │ 0.1029 │  0.1515  │  0.5492   │
│  recall  │  0.0078  │  0.9713  │  0.5697   │ 0.1064 │  0.2055  │  0.5514   │
│   acc    │  0.0028  │  0.9442  │  0.3983   │ 0.0552 │  0.0955  │  0.3796   │
│    f1    │  0.0056  │  0.9713  │  0.5697   │ 0.1046 │  0.1744  │  0.5503   │
│ panopti… │  0.0036  │  0.6189  │  0.3299   │ 0.0579 │  0.1056  │  0.3125   │
└──────────┴──────────┴──────────┴───────────┴────────┴──────────┴───────────┘



# Baseline with hovernet:

## inference

The hovernet doesn't provide their weights used for the lizard dataset.

The dataset used to get our baseline is the CoNSeP dataset, as it is similar to the lizard. In fact, images of the CoNSeP are used in the lizard (TO CHECK THIS).

Hovernet provide weights for the CoNSeP dataset for Segmentation and Classification.

The inference with the weights provided by hovernet was run with this command:

python run_infer.py --gpu='1' --nr_types=5 --model_path=weigths/hovernet_original_consep_type_tf2pytorch.tar --model_mode=original --type_info_path=type_info.json tile --input_dir ../../data/CoNSeP/Test/Images/ --output_dir test_out

## metrics baseline

The metrics can then be computed with the following command for segmentation :

python compute_stats.py --pred_dir test_out/mat --true_dir ../../data/CoNSeP/Test/Labels

And with the following command for classification :

python compute_stats.py --pred_dir test_out/mat --true_dir ../../data/CoNSeP/Test/Labels --mode type

### segmentation

The results are the following:

From the paper:

CoNSeP Hover-Net (Table 3):
DICE:   0.853
AJI:    0.571
DQ:     0.702
SQ:     0.778
PQ:     0.547

CoNSeP Hover-Net with loss strategy (Table A1):
DICE:   0.853    
AJI:    0.702
DQ:     0.778
SQ:     0.547
PQ:     0.571

CoNSeP Hover-Net with post precessing (Table A2):
DICE:   0.853    
AJI:    0.571
DQ:     0.702
SQ:     0.778
PQ:     0.547
    
It looks like the table A1 is wrong.

Result of segmentation stats computation: 
[ 0.84817  0.54631  0.66803  0.77078  0.51617  0.57440]

From the code : 
        metrics[0].append(get_dice_1(true, pred))
        metrics[1].append(get_fast_aji(true, pred))
        metrics[2].append(pq_info[0])  # dq
        metrics[3].append(pq_info[1])  # sq
        metrics[4].append(pq_info[2])  # pq
        metrics[5].append(get_fast_aji_plus(true, pred))

So the resulting metrics from our computation is :

DICE:   0.84817    
AJI:    0.54631
DQ:     0.66803
SQ:     0.77078
PQ:     0.51617

Which is pretty similar from the paper.

### classification

The results are the following:

From the paper:

Fd denotes the F1 score for nuclear detection, whereas Fec , Fic , Fsc and Fmc denote the F1 classification score for the epithelial, inflammatory, spindle-shaped and miscellaneous classes respectively

Consep Hover-Net (Table 5 and A3):
PQ      0.516 
Fd      0.748 
Fec     0.635 
Fic     0.631 
Fsc     0.566 
Fmc     0.426

Result of classification stats computation: 
[ 0.74850  0.87197  0.42644  0.63083  0.63539  0.56706]

From the code:
    results_list = [f1_d, acc_type]
    for type_uid in type_uid_list:
        f1_type = _f1_type(
            paired_true_type,
            paired_pred_type,
            unpaired_true_type,
            unpaired_pred_type,
            type_uid,
            w,
        )
        results_list.append(f1_type)

And printing the type_uid_list:
    [1, 2, 3, 4]
And the config of the inference is:
{
    "0" : ["nolabe", [0  ,   0,   0]], 
    "1" : ["other", [255,   0,   0]], 
    "2" : ["inflammatory", [0  , 255,   0]], 
    "3" : ["epithelial", [0  ,   0, 255]], 
    "4" : ["muscle", [255, 255,   0]]
}

So the resulting metrics from our computation is :

f1_d        0.74850
acc_type    0.87197
fmc         0.42644
fic         0.63083
fec         0.63539
fsc         0.56706

We can see that our results are really close to those in the paper.
We can consider this baseline accurate and continue in the implementation of a graph network on top of it.

## Graph training

A quick graph was trained using the code in hover_net_quick_graph.py.
 
It can be run using :
python hover_net_quick_graph.py --max_epochs 200

The information passed to the graph are only the final classification of the hover_net. The true class is then retrieved using it's centroid and the CoNSeP class map. Some computed centroid were pointing on 0 on the CoNSeP, so for those we needed to keep the background class in the graph output.

The following graph where generated to make a little bit of hyperparametrization: layer 1-4 and dimh 16, 32, 64.

## Inference with graph

Using the already computed inference data, we can run the graph on these.

The code is in the file hover_net_improve_prediction_with_graph.py

It can be run with the following command:

python hover_net_improve_prediction_with_graph.py

It takes as input the prediction of the hovernet and generate a new set of .mat files, which can then be used with the prediction class of the hovernet.

The mat files are saved in the CoNSeP_test_out, in the graph folder, with hyperparm name folder in the form <num_layer>-<dimh>.

### Results and metrics

With out quick graph on top of hovernet, we achieve the following metrics on the classification:


1-16
[ 0.74850  0.33199  0.00440  0.31358  0.03984  0.22138]

2-16
[ 0.74850  0.87258  0.40756  0.62577  0.63945  0.57003]

3-16
[ 0.74850  0.87444  0.42515  0.62700  0.63923  0.57053]

4-16
[ 0.74850  0.87506  0.43297  0.63086  0.63777  0.57068]

5-16
[ 0.74850  0.87104  0.42708  0.62102  0.63868  0.56698]

1-32
[ 0.74850  0.25298  0.00227  0.12685  0.03595  0.19490]

2-32
[ 0.74850  0.87475  0.43344  0.62830  0.64009  0.56916]

3-32
[ 0.74850  0.87552  0.44200  0.62870  0.63941  0.57041]

4-32
[ 0.74850  0.87490  0.43340  0.63083  0.63895  0.56951]

5-32
[ 0.74850  0.87320  0.42629  0.63048  0.63736  0.56791]

1-64
[ 0.74850  0.80053  0.00000  0.54269  0.57593  0.52076]

2-64
[ 0.74850  0.87475  0.42713  0.62950  0.63989  0.56947]

3-64
[ 0.74850  0.87428  0.42732  0.62778  0.63953  0.57010]

4-64
[ 0.74850  0.87459  0.43000  0.62977  0.63935  0.56889]

5-64
[ 0.74850  0.87459  0.43409  0.62977  0.63878  0.56974]


If we select the 4 layers 32 hidden dim version of our graph, we can see that all the metrics are improved or equal to the original metrics from HoverNet:

original HoverNet
[ 0.74850  0.87197  0.42644  0.63083  0.63539  0.56706]
graph improvement
[ 0.74850  0.87490  0.43340  0.63083  0.63895  0.56951]

We can then see that just with a simple graph using only the final classification prediction made from hovernet, we can improve the classification.

# baseline with lizard.

Train lizard for 50 epochs with run_train script and same train/test split as stardist.

Compute_stats.py results :

[ 0.71317  0.46439  0.59182  0.78582  0.46573  0.47996]

So the resulting metrics from our computation is :

DICE:   0.71317    
AJI:    0.46439
DQ:     0.59182
SQ:     0.78582
PQ:     0.46573

[ 0.67770  0.90737  0.19923  0.75764  0.30545  0.29236  0.00000  0.47899]

So the resulting metrics from our computation is :

f1_d        0.67770
acc_type    0.90737
fmc         0.19923
fic         0.75764
fec         0.30545
fsc         0.29236
            0.00000
            0.47899

2 graph models where trained : 2 layers and 4 layers 32hidden size

2: [ 0.67770  0.90585  0.13559  0.75761  0.30352  0.28094  0.05660  0.47918]

4: [ 0.67770  0.90615  0.22120  0.75736  0.30319  0.28879  0.02927  0.47704]
 

2-4     [ 0.67770  0.88902  0.06349  0.75560  0.32036  0.00063  0.01010  0.47821]
4-4     [ 0.67770  0.90554  0.18868  0.75754  0.30278  0.28814  0.03077  0.47607]
8-4     [ 0.67770  0.90719  0.00000  0.75600  0.30284  0.29038  0.01081  0.47657]
16-4    [ 0.67770  0.65431  0.00000  0.54964  0.00000  0.00000  0.00000  0.00000]
2-8     [ 0.67770  0.89018  0.11921  0.75671  0.31897  0.00808  0.06222  0.47996]
4-8     [ 0.67770  0.90621  0.16667  0.75723  0.30248  0.29016  0.04444  0.47839]
8-8     [ 0.67770  0.91091  0.14085  0.75643  0.31559  0.29394  0.01026  0.48030]
16-8    [ 0.67770  0.65754  0.00000  0.55204  0.00000  0.00000  0.00000  0.01427]
2-16    [ 0.67770  0.90688  0.19540  0.75764  0.30572  0.28529  0.03865  0.47861]
4-16    [ 0.67770  0.90652  0.22549  0.75718  0.30518  0.28845  0.04902  0.47648]
8-16    [ 0.67770  0.90774  0.01724  0.75308  0.30658  0.29137  0.00000  0.47925]
16-16   [ 0.67770  0.65754  0.00000  0.55204  0.00000  0.00000  0.00000  0.01427]
2-32    [ 0.67770  0.90609  0.18634  0.75761  0.30480  0.27787  0.06335  0.47871]
4-32    [ 0.67770  0.90695  0.21239  0.75701  0.30741  0.28678  0.04878  0.47879]
8-32    [ 0.67770  0.90865  0.21698  0.75756  0.31206  0.28750  0.04975  0.47907]
16-32   [ 0.67770  0.65754  0.00000  0.55204  0.00000  0.00000  0.00000  0.01427]
2-64    [ 0.67770  0.90774  0.22727  0.75731  0.30947  0.28127  0.03883  0.47981]
4-64    [ 0.67770  0.90786  0.22099  0.75756  0.30744  0.28880  0.03980  0.47919]
8-64    [ 0.67770  0.91109  0.20541  0.75777  0.32199  0.28720  0.04608  0.47996]
16-64   [ 0.67770  0.65754  0.00000  0.55204  0.00000  0.00000  0.00000  0.01427]
2-128   [ 0.67770  0.90780  0.21519  0.75754  0.30565  0.29165  0.04762  0.47971]
4-128   [ 0.67770  0.90682  0.22326  0.75728  0.30594  0.28917  0.03960  0.47677]
8-128   [ 0.67770  0.90841  0.20541  0.75738  0.30945  0.29192  0.06573  0.47934]
16-128  [ 0.67770  0.65754  0.00000  0.55204  0.00000  0.00000  0.00000  0.01427]

Best looks like it is 8-64, which is better every where except for 6th metrics.

# Big hyper param

for dimh in 16 32 64 128 256 512
do
for numlayer in 2 4 8 16
do
for model in graph_gat #graph_sage graph_gat graph_gin

best is graph sage everywhere. especially 4layers 256 dim


# graph sage 2lay-256dh-4ll+c + stardist 4 times for classification
Results:

    Segmentation metrics     
┏━━━━━━━━━━━━━━━━━━┳━━━━━━━━┓
┃      Metric      ┃ Value  ┃
┡━━━━━━━━━━━━━━━━━━╇━━━━━━━━┩
│    precision     │ 0.8549 │
│      recall      │ 0.8807 │
│       acc        │ 0.7661 │
│        f1        │ 0.8676 │
│ panoptic_quality │ 0.6919 │
└──────────────────┴────────┘
                  Classification metrics                  
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┓
┃ metric \ avg ┃       micro        ┃       macro        ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━┩
│   Accuracy   │ 0.9198868274688721 │ 0.6666551232337952 │
│      F1      │ 0.9198868274688721 │ 0.6938601732254028 │
└──────────────┴────────────────────┴────────────────────┘
                              Per class metrics                               
┏━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┓
┃          ┃          ┃          ┃           ┃        ┃          ┃ Connecti… ┃
┃  Class   ┃ Neutrop… ┃ Epithel… ┃ Lymphocy… ┃ Plasma ┃ Eosinop… ┃  tissue   ┃
┡━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━┩
│ precisi… │  0.0105  │  0.9467  │  0.7131   │ 0.1967 │  0.1618  │  0.5738   │
│  recall  │  0.0156  │  0.9467  │  0.7131   │ 0.2043 │  0.1918  │  0.5761   │
│   acc    │  0.0063  │  0.8988  │  0.5541   │ 0.1114 │  0.0962  │  0.4035   │
│    f1    │  0.0126  │  0.9467  │  0.7131   │ 0.2004 │  0.1755  │  0.5749   │
│ panopti… │  0.0087  │  0.6102  │  0.4298   │ 0.1109 │  0.1118  │  0.3359   │
└──────────┴──────────┴──────────┴───────────┴────────┴──────────┴───────────┘
                              Per class metrics                               
┏━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━┓
┃          ┃          ┃          ┃           ┃        ┃          ┃ Connecti… ┃
┃  Class   ┃ Neutrop… ┃ Epithel… ┃ Lymphocy… ┃ Plasma ┃ Eosinop… ┃  tissue   ┃
┡━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━┩
│ precisi… │  0.0791  │  0.9672  │  0.6639   │ 0.2459 │  0.1813  │  0.6885   │
│  recall  │  0.1094  │  0.9672  │  0.6639   │ 0.2553 │  0.2260  │  0.6914   │
│   acc    │  0.0481  │  0.9365  │  0.4969   │ 0.1432 │  0.1119  │  0.5266   │
│    f1    │  0.0918  │  0.9672  │  0.6639   │ 0.2505 │  0.2012  │  0.6899   │
│ panopti… │  0.0533  │  0.6288  │  0.3933   │ 0.1416 │  0.1270  │  0.4096   │
└──────────┴──────────┴──────────┴───────────┴────────┴──────────┴───────────┘



TODO :

stardist :

200 no aug - done
200 rotate - in progress
200 rotate + bright
200 croped
200 croped lr * 2
200 power scale ** 2
200 no power scale

Graph :

redo all sheets
improve sage custom

hovernet :
proof of concept graph with validation selection

hovernet lizard :
extraction train
graph training
validation selection
test graph